<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - MetalTracker</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-pic-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            cursor: pointer;
        }

        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            color: white;
            font-size: 0.8rem;
        }

        .profile-pic-wrapper:hover .overlay {
            opacity: 1;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--accent-gold);
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .row {
            display: flex;
            gap: 15px;
        }

        .row>* {
            flex: 1;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-gold);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            border-color: var(--accent-gold);
            background: rgba(240, 192, 64, 0.1);
        }
    </style>
</head>

<body>
    <div class="container fade-in" style="max-width: 800px; padding: 40px 20px;">

        <div class="flex-center" style="margin-bottom: 20px;">
            <h1>Settings</h1>
            <button style="width: auto;" class="btn-outline" onclick="window.location.href='dashboard.html'">Back to
                Dashboard</button>
        </div>

        <div class="card slide-up">
            <div class="profile-header">
                <div class="profile-pic-wrapper" onclick="document.getElementById('file-upload').click()">
                    <img id="profile-img" src="http://localhost:5000/uploads/default.png" alt="Profile"
                        class="profile-pic"
                        onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23f0c040\'><path d=\'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\'/></svg>'">
                    <div class="overlay">Upload</div>
                    <input type="file" id="file-upload" style="display: none;" accept="image/*"
                        onchange="uploadPic(event)">
                </div>
                <div>
                    <h2 id="display-name">Loading...</h2>
                    <p id="display-email" style="color: var(--text-secondary);"></p>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <h3 class="section-title">Edit Profile</h3>
                    <label>Full Name</label>
                    <input type="text" id="name-input">
                    <button style="margin-top: 10px;" id="btn-save-profile" onclick="saveProfile()">Save
                        Profile</button>
                    <span class="success-text" id="profile-msg"></span>
                </div>

                <div class="form-group">
                    <h3 class="section-title">Preferences</h3>
                    <div class="flex-center" style="margin-bottom: 15px;">
                        <span>Light Theme</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" onchange="updatePreferences()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <label>Currency</label>
                    <select id="currency-select" onchange="updatePreferences()">
                        <option value="USD">USD ($)</option>
                        <option value="PKR">PKR (Rs)</option>
                    </select>
                    <label style="margin-top:10px;">Weight Unit</label>
                    <select id="unit-select" onchange="updatePreferences()">
                        <option value="tola">Per Tola (11.66g)</option>
                        <option value="gram">Per Gram</option>
                        <option value="toz">Per Troy Oz (31.1g)</option>
                    </select>
                </div>
            </div>

            <div class="row" style="margin-top: 20px;">
                <div class="form-group">
                    <h3 class="section-title">Change Password</h3>
                    <input type="password" id="current-password" placeholder="Old Password">
                    <input type="password" id="new-password" placeholder="New Password (min 8, 1 number)">
                    <input type="password" id="confirm-password" placeholder="Confirm New Password">
                    <button style="margin-top: 10px;" id="btn-pwd" onclick="changePassword()">Update Password</button>
                    <span class="error-text" id="pwd-msg" style="margin-top: 10px;"></span>
                </div>

                <div class="form-group">
                    <h3 class="section-title">Change Email</h3>
                    <div id="email-step1">
                        <input type="email" id="new-email" placeholder="New Email Address">
                        <button style="margin-top: 10px;" id="btn-email-code" onclick="sendEmailCode()">Send
                            Verification Code</button>
                    </div>
                    <div id="email-step2" style="display: none;">
                        <p style="font-size: 0.85rem; margin-bottom: 10px;">Enter code sent to new email.</p>
                        <div class="code-inputs" style="justify-content: flex-start;">
                            <input type="text" maxlength="1" id="e1">
                            <input type="text" maxlength="1" id="e2">
                            <input type="text" maxlength="1" id="e3">
                            <input type="text" maxlength="1" id="e4">
                        </div>
                        <button id="btn-verify-email" onclick="verifyEmailChange()">Confirm Change</button>
                    </div>
                    <span class="error-text" id="email-msg" style="margin-top: 10px;"></span>
                </div>
            </div>

            <button style="margin-top:20px; background-color: var(--error); color: white;" onclick="logout()">Log
                Out</button>

        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script>
        if (!getToken()) window.location.href = 'login.html';
        // Use initProtectedPage to handle token checks and theme application
        initProtectedPage();

        const msgProfile = document.getElementById('profile-msg');
        const msgPwd = document.getElementById('pwd-msg');
        const msgEmail = document.getElementById('email-msg');

        async function loadProfile() {
            try {
                const data = await api.user.getProfile();
                if (!data) return; // handled by api wrapper

                document.getElementById('display-name').textContent = data.name;
                document.getElementById('display-email').textContent = data.email;
                document.getElementById('name-input').value = data.name;

                // Set profile picture src
                if (data.profile_pic) {
                    document.getElementById('profile-img').src = `http://localhost:5000/uploads/${data.profile_pic}?t=${new Date().getTime()}`;
                }

                // Set preferences
                document.getElementById('theme-toggle').checked = data.theme === 'light';
                document.getElementById('currency-select').value = data.currency;
                document.getElementById('unit-select').value = data.unit;

                // Ensure theme matches data from server
                applyTheme(data.theme);

            } catch (err) {
                console.error('Failed to load profile:', err);
            }
        }

        async function uploadPic(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('profile_pic', file);

            try {
                // Cannot use standard api.post because it stringifies JSON. Need a custom fetch or api extension.
                // Or just use fetch directly with token
                const token = getToken();
                const res = await fetch(`http://localhost:5000/api/user/upload-pic`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (res.status === 401) {
                    logout();
                    return;
                }

                const data = await res.json();
                if (res.ok) {
                    document.getElementById('profile-img').src = `http://localhost:5000/uploads/${data.filename}?t=${new Date().getTime()}`;
                    showToast('Profile picture updated!', 'success');
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Upload failed due to network error', 'error');
            }
        }

        async function saveProfile() {
            const name = document.getElementById('name-input').value;
            const theme = document.getElementById('theme-toggle').checked ? 'light' : 'dark';
            const currency = document.getElementById('currency-select').value;
            const unit = document.getElementById('unit-select').value;

            const btn = document.getElementById('btn-save-profile');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            btn.disabled = true;

            try {
                const data = await api.user.updateProfile({ name, theme, currency, unit });
                if (data) {
                    msgProfile.textContent = 'Profile updated.';
                    msgProfile.style.color = 'var(--success)';
                    document.getElementById('display-name').textContent = name;

                    // Update user in localStorage
                    const user = getUser();
                    user.theme = theme;
                    user.currency = currency;
                    user.unit = unit;
                    localStorage.setItem('metaltracker_user', JSON.stringify(user));

                    applyTheme(theme);
                    showToast('Profile saved successfully', 'success');
                    setTimeout(() => msgProfile.textContent = '', 3000);
                }
            } catch (err) {
                msgProfile.textContent = 'Update failed.';
                msgProfile.style.color = 'var(--error)';
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function updatePreferences() {
            const isLight = document.getElementById('theme-toggle').checked;
            applyTheme(isLight ? 'light' : 'dark');
            saveProfile(); // Auto-save on change
        }

        async function changePassword() {
            const oldPassword = document.getElementById('current-password').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();

            if (!oldPassword) { showToast('Please enter current password', 'error'); return; }
            if (newPassword.length < 8) { showToast('New password must be at least 8 characters', 'error'); return; }
            if (!/\d/.test(newPassword)) { showToast('New password must contain at least one digit', 'error'); return; }
            if (newPassword !== confirmPassword) { showToast('Passwords do not match', 'error'); return; }

            try {
                const token = getToken();
                const res = await fetch('http://localhost:5000/api/user/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Failed to change password');

                msgPwd.textContent = 'Password changed successfully.';
                msgPwd.style.color = 'var(--success)';
                showToast('Password changed successfully!', 'success');

                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } catch (err) {
                msgPwd.textContent = err.message;
                msgPwd.style.color = 'var(--error)';
                showToast(err.message, 'error');
            }
        }

        let pendingEmail = '';
        async function sendEmailCode() {
            const email = document.getElementById('new-email').value;
            if (!email) {
                msgEmail.textContent = "Please enter an email address";
                return;
            }

            const btn = document.getElementById('btn-email-code');
            const originalText = btn.innerText;
            btn.innerText = 'Sending...';
            btn.disabled = true;

            try {
                const data = await api.user.sendEmailChange({ newEmail: email });
                if (data) {
                    pendingEmail = email;
                    document.getElementById('email-step1').style.display = 'none';
                    document.getElementById('email-step2').style.display = 'block';
                    msgEmail.textContent = '';
                    showToast('Verification code sent', 'success');
                }
            } catch (err) {
                msgEmail.textContent = 'Failed to send code';
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function verifyEmailChange() {
            const code = document.getElementById('e1').value + document.getElementById('e2').value +
                document.getElementById('e3').value + document.getElementById('e4').value;

            if (code.length < 4) {
                msgEmail.textContent = "Please enter the 4-digit code";
                return;
            }

            const btn = document.getElementById('btn-verify-email');
            const originalText = btn.innerText;
            btn.innerText = 'Verifying...';
            btn.disabled = true;

            try {
                const data = await api.user.confirmEmailChange({ newEmail: pendingEmail, code });
                if (data) {
                    msgEmail.textContent = 'Email updated successfully';
                    msgEmail.style.color = 'var(--success)';
                    document.getElementById('display-email').textContent = pendingEmail;
                    document.getElementById('email-step2').style.display = 'none';
                    document.getElementById('email-step1').style.display = 'block';
                    document.getElementById('new-email').value = '';

                    showToast('Email address changed', 'success');

                    // Clear inputs
                    ['e1', 'e2', 'e3', 'e4'].forEach(id => document.getElementById(id).value = '');
                    pendingEmail = '';
                }
            } catch (err) {
                msgEmail.textContent = 'Invalid code or error occurred';
                msgEmail.style.color = 'var(--error)';
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // Auto focus script for email verify
        const inputs = ['e1', 'e2', 'e3', 'e4'];
        inputs.forEach((id, i) => {
            document.getElementById(id).addEventListener('input', function () {
                if (this.value.length >= 1 && i < 3) document.getElementById(inputs[i + 1]).focus();
            });
            document.getElementById(id).addEventListener('keydown', function (e) {
                if (e.key === 'Backspace' && !this.value && i > 0) document.getElementById(inputs[i - 1]).focus();
            });
        });

        // Load profile data on init
        loadProfile();
    </script>
</body>

</html>